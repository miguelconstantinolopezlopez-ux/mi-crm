<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>CRM Multiusuario con Google Sheets</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
    h2 { 
      color: #333; 
      font-size: 18px;
      margin-bottom: 12px;
      margin-top: 0;
    }
    h3 { 
      color: #333; 
      font-size: 14px;
      margin-bottom: 10px;
      margin-top: 15px;
    }
    .login, .dashboard, .admin-panel, .config-panel { 
      background: #fff; 
      padding: 15px; 
      border-radius: 8px; 
      box-shadow: 0 2px 6px rgba(0,0,0,0.1); 
      margin-bottom: 15px; 
      max-width: 480px; 
    }
    input, button, select, textarea { 
      padding: 6px; 
      margin: 3px 0; 
      border: 1px solid #ccc; 
      border-radius: 4px; 
      width: 100%; 
      box-sizing: border-box; 
      font-size: 12px;
      font-family: Arial, sans-serif;
    }
    textarea {
      resize: vertical;
      min-height: 100px;
    }
    button { 
      background: #007bff; 
      color: #fff; 
      cursor: pointer; 
      font-size: 12px;
      font-weight: 500;
      transition: background-color 0.2s;
    }
    button:hover { background: #0056b3; }
    .google-btn { background: #34a853; }
    .google-btn:hover { background: #2d8f47; }
    .config-btn { background: #6f42c1; }
    .config-btn:hover { background: #5a359a; }
    table { border-collapse: collapse; width: 100%; margin-top: 15px; table-layout: fixed; min-width: 900px; }
    th, td { 
      border: 1px solid #ddd; 
      padding: 8px 4px; 
      text-align: center; 
      font-size: 11px; 
      vertical-align: middle; 
      word-wrap: break-word;
      word-break: break-word;
      overflow-wrap: break-word;
      hyphens: auto;
      max-width: 0;
    }
    th { 
      background: #007bff; 
      color: #fff; 
      font-weight: bold;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .table-container { overflow-x: auto; margin-top: 15px; border: 1px solid #ddd; }
    /* Anchos espec√≠ficos para tabla de clientes */
    #tablaClientes th:nth-child(1), #tablaClientes td:nth-child(1) { width: 100px; min-width: 100px; max-width: 100px; }
    #tablaClientes th:nth-child(2), #tablaClientes td:nth-child(2) { width: 110px; min-width: 110px; max-width: 110px; }
    #tablaClientes th:nth-child(3), #tablaClientes td:nth-child(3) { width: 90px; min-width: 90px; max-width: 90px; }
    #tablaClientes th:nth-child(4), #tablaClientes td:nth-child(4) { width: 150px; min-width: 150px; max-width: 150px; }
    #tablaClientes th:nth-child(5), #tablaClientes td:nth-child(5) { width: 90px; min-width: 90px; max-width: 90px; }
    #tablaClientes th:nth-child(6), #tablaClientes td:nth-child(6) { width: 120px; min-width: 120px; max-width: 120px; }
    #tablaClientes th:nth-child(7), #tablaClientes td:nth-child(7) { width: 100px; min-width: 100px; max-width: 100px; }
    /* Anchos espec√≠ficos para tabla de usuarios */
    #tablaUsuarios th:nth-child(1), #tablaUsuarios td:nth-child(1) { width: 200px; min-width: 200px; max-width: 200px; }
    #tablaUsuarios th:nth-child(2), #tablaUsuarios td:nth-child(2) { width: 150px; min-width: 150px; max-width: 150px; }
    #tablaUsuarios th:nth-child(3), #tablaUsuarios td:nth-child(3) { width: 80px; min-width: 80px; max-width: 80px; }
    #tablaUsuarios th:nth-child(4), #tablaUsuarios td:nth-child(4) { width: 120px; min-width: 120px; max-width: 120px; }
    /* Anchos espec√≠ficos para tabla de clientes eliminados */
    #tablaClientesEliminados th:nth-child(1), #tablaClientesEliminados td:nth-child(1) { width: 120px; min-width: 120px; max-width: 120px; }
    #tablaClientesEliminados th:nth-child(2), #tablaClientesEliminados td:nth-child(2) { width: 140px; min-width: 140px; max-width: 140px; }
    #tablaClientesEliminados th:nth-child(3), #tablaClientesEliminados td:nth-child(3) { width: 100px; min-width: 100px; max-width: 100px; }
    #tablaClientesEliminados th:nth-child(4), #tablaClientesEliminados td:nth-child(4) { width: 110px; min-width: 110px; max-width: 110px; }
    #tablaClientesEliminados th:nth-child(5), #tablaClientesEliminados td:nth-child(5) { width: 90px; min-width: 90px; max-width: 90px; }
    #tablaClientesEliminados th:nth-child(6), #tablaClientesEliminados td:nth-child(6) { width: 150px; min-width: 150px; max-width: 150px; }
    #tablaClientesEliminados th:nth-child(7), #tablaClientesEliminados td:nth-child(7) { width: 120px; min-width: 120px; max-width: 120px; }
    .error { color: red; font-size: 14px; }
    .admin-link { margin-top: 10px; display: block; color: #007bff; cursor: pointer; text-decoration: underline; }
    .password-container { position: relative; display: flex; align-items: center; max-width: 100%; }
    .password-container input { 
      flex: 1; 
      padding-right: 25px; 
      width: calc(100% - 30px); 
      font-size: 12px;
    }
    .toggle-password { 
      position: absolute; 
      right: 8px; 
      cursor: pointer; 
      font-size: 12px;
      user-select: none;
    }
    .register-comment { 
      font-size: 11px; 
      color: #555; 
      margin-top: 8px; 
      line-height: 1.3;
    }
    .register-btn { background: #28a745; margin-top: 10px; }
    .register-btn:hover { background: #218838; }
    .admin-actions { display: flex; gap: 5px; justify-content: center; }
    .admin-actions button { width: auto; padding: 5px 10px; font-size: 12px; }
    .edit-btn { background: #ffc107; color: #000; }
    .edit-btn:hover { background: #e0a800; }
    .delete-btn { background: #dc3545; }
    .delete-btn:hover { background: #c82333; }
    .export-section { margin-bottom: 20px; }
    .export-section button { margin: 5px; }
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #dc3545;
      color: white;
      padding: 12px 20px;
      border-radius: 5px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      z-index: 1000;
      font-size: 14px;
      font-weight: 500;
      opacity: 0;
      transform: translateX(100%);
      transition: all 0.3s ease;
    }
    .notification.show {
      opacity: 1;
      transform: translateX(0);
    }
    .notification.success {
      background: #28a745;
    }
    .notification.warning {
      background: #ffc107;
      color: #000;
    }
    .google-status {
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      font-size: 12px;
    }
    .google-status.connected {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .google-status.disconnected {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .button-group {
      display: flex;
      gap: 5px;
      margin: 5px 0;
    }
    .button-group button {
      flex: 1;
    }
  </style>
</head>
<body>

<div class="login" id="login">
  <h2>Iniciar Sesi√≥n</h2>
  <input type="email" id="email" placeholder="Correo"><br>
  <div class="password-container">
    <input type="password" id="password" placeholder="Contrase√±a">
    <span class="toggle-password" onclick="togglePassword('password', this)">üëÅÔ∏è</span>
  </div>
  <button onclick="login()">Ingresar</button>
  <p id="errorMsg" class="error"></p>
  <span class="admin-link" onclick="showAdminLogin()">Acceder como Administrador</span>
  <p class="register-comment">Si no te has registrado, puedes hacerlo con el bot√≥n de Registrarse. <strong>Toda la informaci√≥n de los clientes se almacena en el usuario de administrador</strong>.</p>
  <button class="register-btn" onclick="registrarse()">Registrarse</button>
</div>

<div class="login" id="adminLogin" style="display:none">
  <h2>Login Administrador</h2>
  <input type="email" id="adminEmail" placeholder="Correo"><br>
  <div class="password-container">
    <input type="password" id="adminPassword" placeholder="Contrase√±a">
    <span class="toggle-password" onclick="togglePassword('adminPassword', this)">üëÅÔ∏è</span>
  </div>
  <button onclick="adminLogin()">Ingresar</button>
  <p id="adminError" class="error"></p>
  <button onclick="backToLogin()" style="background: #6c757d; margin-top: 10px;">Volver al Login</button>
</div>

<div class="config-panel" id="configPanel" style="display:none">
  <h2>Configuraci√≥n de Google Sheets</h2>
  <div id="googleStatus" class="google-status disconnected">
    Estado: Desconectado de Google Sheets
  </div>
  
  <h3>Configurar Google Apps Script</h3>
  <p style="font-size: 12px; color: #666; line-height: 1.4;">
    Para usar esta funcionalidad, necesitas crear un Google Apps Script. 
    Copia el c√≥digo de abajo y p√©galo en un nuevo proyecto de Google Apps Script.
  </p>
  
  <textarea id="appsScriptCode" readonly style="font-family: monospace; font-size: 10px;">
function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const spreadsheetId = "1UXjttF6ZYAd_YGXzBdrphE6b7AW47PXALRy--4mQUXQ";
    const sheetName = "pospectos";
    
    const spreadsheet = SpreadsheetApp.openById(spreadsheetId);
    let sheet = spreadsheet.getSheetByName(sheetName);
    
    if (!sheet) {
      sheet = spreadsheet.insertSheet(sheetName);
      sheet.getRange(1, 1, 1, 5).setValues([["Tel√©fono", "Motocicleta", "Tipo de Pago", "Comentario", "Fecha"]]);
    }
    
    const lastRow = sheet.getLastRow();
    
    data.clientes.forEach((cliente, index) => {
      sheet.getRange(lastRow + index + 1, 1, 1, 5).setValues([[
        cliente.telefono,
        cliente.motocicleta,
        cliente.pago,
        cliente.comentario,
        cliente.fecha
      ]]);
    });
    
    return ContentService
      .createTextOutput(JSON.stringify({ success: true, message: `${data.clientes.length} clientes agregados correctamente` }))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({ success: false, message: error.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}</textarea>

  <h3>URL del Web App</h3>
  <input type="text" id="webAppUrl" placeholder="Pega aqu√≠ la URL de tu Google Apps Script Web App">
  
  <div class="button-group">
    <button onclick="guardarConfiguracion()">Guardar Config</button>
    <button onclick="probarConexion()">Probar Conexi√≥n</button>
  </div>
  
  <button onclick="volverAlPanel()" style="background: #6c757d; margin-top: 10px;">Volver al Panel</button>
</div>

<div class="dashboard" id="dashboard" style="display:none">
  <h2>Bienvenido <span id="userName"></span></h2>
  <div id="googleStatusUser" class="google-status disconnected" style="display:none;">
    Google Sheets: Desconectado
  </div>
  
  <input type="text" id="clienteTel" placeholder="Tel√©fono">
  <input type="text" id="clienteMotocicleta" placeholder="Motocicleta">
  <input type="text" id="clientePago" placeholder="Tipo de pago">
  <input type="text" id="clienteComentario" placeholder="Comentario">
  <select id="clienteEstado">
    <option value="Nuevo">Nuevo</option>
    <option value="En proceso">En proceso</option>
    <option value="Cerrado">Cerrado</option>
  </select>
  <button onclick="agregarCliente()">Agregar cliente</button>
  
  <div class="button-group">
    <button onclick="exportarExcelClientes()">Exportar Excel</button>
    <button class="google-btn" onclick="enviarAGoogleSheets()">üìä Enviar a Google Sheets</button>
  </div>
  
  <button onclick="logout()" style="background: #6c757d; margin-top: 10px;">Cerrar Sesi√≥n</button>

  <div class="table-container">
    <table id="tablaClientes">
      <thead><tr><th>Tel√©fono</th><th>Motocicleta</th><th>Tipo de Pago</th><th>Comentario</th><th>Estado</th><th>Fecha</th><th>Acciones</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div class="admin-panel" id="adminPanel" style="display:none">
  <h2>Panel de Administrador</h2>
  
  <div class="export-section">
    <button onclick="exportarExcelUsuarios()">Exportar Excel Usuarios</button>
    <button onclick="exportarExcelTodosClientes()">Exportar Excel Todos los Clientes</button>
    <button onclick="exportarExcelClientesEliminados()">Exportar Excel Clientes Eliminados</button>
    <button class="google-btn" onclick="enviarTodosLosClientesAGoogleSheets()">üìä Enviar Todos a Google Sheets</button>
    <button class="config-btn" onclick="mostrarConfiguracion()">‚öôÔ∏è Configurar Google Sheets</button>
    <button onclick="logout()" style="background: #6c757d;">Cerrar Sesi√≥n</button>
  </div>

  <h3>Gesti√≥n de Usuarios</h3>
  <div class="table-container">
    <table id="tablaUsuarios">
      <thead><tr><th>Correo</th><th>Contrase√±a</th><th>Clientes</th><th>Acciones</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <h3>Clientes Eliminados</h3>
  <div class="table-container">
    <table id="tablaClientesEliminados">
      <thead><tr><th>Fecha Eliminaci√≥n</th><th>Eliminado por</th><th>Tel√©fono</th><th>Motocicleta</th><th>Pago</th><th>Comentario</th><th>Fecha Original</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
let currentUser = null;

// Configuraci√≥n de Google Sheets
function loadGoogleConfig() {
  return JSON.parse(localStorage.getItem("googleConfig") || "{}");
}

function saveGoogleConfig(config) {
  localStorage.setItem("googleConfig", JSON.stringify(config));
}

function guardarConfiguracion() {
  const webAppUrl = document.getElementById("webAppUrl").value.trim();
  
  if (!webAppUrl) {
    showNotification("Debes ingresar la URL del Web App", "error");
    return;
  }
  
  if (!webAppUrl.includes("script.google.com")) {
    showNotification("La URL debe ser de Google Apps Script", "error");
    return;
  }
  
  const config = {
    webAppUrl: webAppUrl,
    configured: true,
    configDate: new Date().toLocaleString()
  };
  
  saveGoogleConfig(config);
  updateGoogleStatus();
  showNotification("Configuraci√≥n guardada correctamente", "success");
}

function probarConexion() {
  const config = loadGoogleConfig();
  
  if (!config.configured) {
    showNotification("Primero debes guardar la configuraci√≥n", "error");
    return;
  }
  
  showNotification("Probando conexi√≥n...", "warning");
  
  const testData = {
    clientes: [{
      telefono: "TEST-123",
      motocicleta: "TEST",
      pago: "TEST",
      comentario: "Prueba de conexi√≥n",
      fecha: new Date().toLocaleString()
    }]
  };
  
  enviarDatosAGoogleSheets(testData)
    .then(response => {
      if (response.success) {
        showNotification("‚úÖ Conexi√≥n exitosa con Google Sheets", "success");
        updateGoogleStatus(true);
      } else {
        showNotification("‚ùå Error: " + response.message, "error");
        updateGoogleStatus(false);
      }
    })
    .catch(error => {
      showNotification("‚ùå Error de conexi√≥n: " + error.message, "error");
      updateGoogleStatus(false);
    });
}

function updateGoogleStatus(isConnected = null) {
  const config = loadGoogleConfig();
  const connected = isConnected !== null ? isConnected : config.configured;
  
  const statusElements = [
    document.getElementById("googleStatus"),
    document.getElementById("googleStatusUser")
  ];
  
  statusElements.forEach(element => {
    if (element) {
      element.className = `google-status ${connected ? 'connected' : 'disconnected'}`;
      element.textContent = connected ? 
        "Estado: Conectado a Google Sheets ‚úÖ" : 
        "Estado: Desconectado de Google Sheets ‚ùå";
    }
  });
}

function mostrarConfiguracion() {
  document.getElementById("adminPanel").style.display = "none";
  document.getElementById("configPanel").style.display = "block";
  
  // Cargar configuraci√≥n actual
  const config = loadGoogleConfig();
  if (config.webAppUrl) {
    document.getElementById("webAppUrl").value = config.webAppUrl;
  }
  
  updateGoogleStatus();
}

function volverAlPanel() {
  document.getElementById("configPanel").style.display = "none";
  document.getElementById("adminPanel").style.display = "block";
}

async function enviarDatosAGoogleSheets(data) {
  const config = loadGoogleConfig();
  
  if (!config.configured) {
    throw new Error("Google Sheets no est√° configurado");
  }
  
  const response = await fetch(config.webAppUrl, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(data)
  });
  
  if (!response.ok) {
    throw new Error(`Error HTTP: ${response.status}`);
  }
  
  return await response.json();
}

function enviarAGoogleSheets() {
  const usuarios = loadUsuarios();
  
  if (!usuarios[currentUser] || !usuarios[currentUser].clientes || usuarios[currentUser].clientes.length === 0) {
    showNotification("No tienes clientes para enviar", "error");
    return;
  }
  
  const clientes = usuarios[currentUser].clientes.map(c => ({
    telefono: c.tel,
    motocicleta: c.motocicleta,
    pago: c.pago,
    comentario: c.comentario,
    fecha: c.fecha
  }));
  
  showNotification("Enviando datos a Google Sheets...", "warning");
  
  enviarDatosAGoogleSheets({ clientes })
    .then(response => {
      if (response.success) {
        showNotification(`‚úÖ ${response.message}`, "success");
      } else {
        showNotification("‚ùå Error: " + response.message, "error");
      }
    })
    .catch(error => {
      showNotification("‚ùå Error al enviar: " + error.message, "error");
    });
}

function enviarTodosLosClientesAGoogleSheets() {
  const usuarios = loadUsuarios();
  let todosLosClientes = [];
  
  Object.keys(usuarios).forEach(email => {
    if (usuarios[email].clientes) {
      usuarios[email].clientes.forEach(cliente => {
        todosLosClientes.push({
          telefono: cliente.tel,
          motocicleta: cliente.motocicleta,
          pago: cliente.pago,
          comentario: cliente.comentario,
          fecha: cliente.fecha
        });
      });
    }
  });
  
  if (todosLosClientes.length === 0) {
    showNotification("No hay clientes para enviar", "error");
    return;
  }
  
  showNotification("Enviando todos los clientes a Google Sheets...", "warning");
  
  enviarDatosAGoogleSheets({ clientes: todosLosClientes })
    .then(response => {
      if (response.success) {
        showNotification(`‚úÖ ${response.message}`, "success");
      } else {
        showNotification("‚ùå Error: " + response.message, "error");
      }
    })
    .catch(error => {
      showNotification("‚ùå Error al enviar: " + error.message, "error");
    });
}

function togglePassword(inputId, icon){
  const input = document.getElementById(inputId);
  input.type = (input.type === 'password') ? 'text' : 'password';
  icon.textContent = (input.type === 'password') ? 'üëÅÔ∏è' : 'üôà';
}

function loadUsuarios(){ return JSON.parse(localStorage.getItem("usuarios")||"{}"); }
function saveUsuarios(data){ localStorage.setItem("usuarios", JSON.stringify(data)); }
function loadClientesEliminados(){ return JSON.parse(localStorage.getItem("clientesEliminados")||"[]"); }
function saveClientesEliminados(data){ localStorage.setItem("clientesEliminados", JSON.stringify(data)); }

function login(){
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  let usuarios = loadUsuarios();
  if(usuarios[email] && usuarios[email].password === password){
    currentUser = email;
    document.getElementById("login").style.display="none";
    document.getElementById("dashboard").style.display="block";
    document.getElementById("userName").innerText=email;
    mostrarClientes();
    clearInputs();
    
    // Mostrar estado de Google Sheets para usuarios normales
    updateGoogleStatus();
    const config = loadGoogleConfig();
    if (config.configured) {
      document.getElementById("googleStatusUser").style.display = "block";
    }
  } else {
    document.getElementById("errorMsg").innerText = "Usuario o contrase√±a incorrectos";
  }
}

function registrarse(){
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  if(!email || !password){ alert('Debes ingresar correo y contrase√±a para registrarte'); return; }
  let usuarios = loadUsuarios();
  if(usuarios[email]){ alert('El usuario ya existe'); } 
  else { 
    usuarios[email] = {password: password, clientes: [], fechaRegistro: new Date().toLocaleString()}; 
    saveUsuarios(usuarios); 
    alert('Usuario registrado exitosamente. Toda la informaci√≥n de los clientes se almacena en el usuario de administrador'); 
  }
}

function showAdminLogin(){ 
  document.getElementById("login").style.display="none"; 
  document.getElementById("adminLogin").style.display="block"; 
}

function backToLogin(){
  document.getElementById("adminLogin").style.display="none";
  document.getElementById("login").style.display="block";
  clearAdminInputs();
}

function logout(){
  currentUser = null;
  document.getElementById("dashboard").style.display="none";
  document.getElementById("adminPanel").style.display="none";
  document.getElementById("configPanel").style.display="none";
  document.getElementById("login").style.display="block";
  clearInputs();
  clearAdminInputs();
}

function clearInputs(){
  document.getElementById("email").value = "";
  document.getElementById("password").value = "";
  document.getElementById("errorMsg").innerText = "";
}

function clearAdminInputs(){
  document.getElementById("adminEmail").value = "";
  document.getElementById("adminPassword").value = "";
  document.getElementById("adminError").innerText = "";
}

function adminLogin(){
  const email = document.getElementById("adminEmail").value;
  const password = document.getElementById("adminPassword").value;
  if(email === "churandres9@gmail.com" && password === "Chur%andre9"){
    document.getElementById("adminLogin").style.display="none";
    document.getElementById("adminPanel").style.display="block";
    mostrarUsuarios();
    mostrarClientesEliminados();
    updateGoogleStatus();
  } else {
    document.getElementById("adminError").innerText = "Credenciales incorrectas";
  }
}

function agregarCliente(){
  const tel = document.getElementById("clienteTel").value;
  const motocicleta = document.getElementById("clienteMotocicleta").value;
  const pago = document.getElementById("clientePago").value;
  const comentario = document.getElementById("clienteComentario").value;
  const estado = document.getElementById("clienteEstado").value;

  if(!tel){ 
    showNotification('El tel√©fono es obligatorio', 'error');
    return; 
  }

  let usuarios = loadUsuarios();
  if(!usuarios[currentUser]) usuarios[currentUser] = {password:"", clientes:[]};
  
  let cliente={
    tel: tel,
    motocicleta: motocicleta,
    pago: pago,
    comentario: comentario,
    estado: estado,
    fecha: new Date().toLocaleString()
  };
  
  usuarios[currentUser].clientes.push(cliente);
  saveUsuarios(usuarios);
  mostrarClientes();
  
  // Limpiar formulario
  document.getElementById("clienteTel").value = "";
  document.getElementById("clienteMotocicleta").value = "";
  document.getElementById("clientePago").value = "";
  document.getElementById("clienteComentario").value = "";
  document.getElementById("clienteEstado").value = "Nuevo";
  
  // Mostrar notificaci√≥n de √©xito
  showNotification(`Cliente con tel√©fono "${tel}" agregado exitosamente`, 'success');
}

function mostrarClientes(){
  let usuarios = loadUsuarios();
  let tbody=document.querySelector("#tablaClientes tbody");
  tbody.innerHTML="";
  if(usuarios[currentUser] && usuarios[currentUser].clientes){
    usuarios[currentUser].clientes.forEach((c,i)=>{
      // Funci√≥n para truncar texto
      const truncateText = (text, maxLength) => {
        if (!text) return '';
        return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
      };
      
      tbody.innerHTML += `<tr>
        <td title="${c.tel}">${truncateText(c.tel, 12)}</td>
        <td title="${c.motocicleta}">${truncateText(c.motocicleta, 14)}</td>
        <td title="${c.pago}">${truncateText(c.pago, 10)}</td>
        <td title="${c.comentario}">${truncateText(c.comentario, 20)}</td>
        <td><select onchange="cambiarEstado(${i}, this.value)" style="width: 100%; font-size: 10px; padding: 2px;">
          <option ${c.estado==='Nuevo'?'selected':''}>Nuevo</option>
          <option ${c.estado==='En proceso'?'selected':''}>En proceso</option>
          <option ${c.estado==='Cerrado'?'selected':''}>Cerrado</option>
        </select></td>
        <td title="${c.fecha}" style="font-size: 9px;">${truncateText(c.fecha, 16)}</td>
        <td><button onclick="eliminarCliente(${i})" class="delete-btn" style="font-size: 9px; padding: 2px 4px; width: 100%;">Del</button></td>
      </tr>`;
    });
  }
}

function cambiarEstado(i,estado){ 
  let usuarios=loadUsuarios(); 
  usuarios[currentUser].clientes[i].estado=estado; 
  saveUsuarios(usuarios); 
}

function eliminarCliente(i){ 
  let usuarios = loadUsuarios();
  const cliente = usuarios[currentUser].clientes[i];
  const telCliente = cliente ? cliente.tel || 'Cliente sin tel√©fono' : 'Cliente';
  
  if(confirm(`¬øEliminar el cliente con tel√©fono "${telCliente}"?`)){
    // Guardar informaci√≥n del cliente eliminado
    let clientesEliminados = loadClientesEliminados();
    const clienteEliminado = {
      ...cliente, // Copia toda la informaci√≥n del cliente
      eliminadoPor: currentUser,
      fechaEliminacion: new Date().toLocaleString(),
      fechaOriginal: cliente.fecha
    };
    clientesEliminados.push(clienteEliminado);
    saveClientesEliminados(clientesEliminados);
    
    // Eliminar el cliente de la lista activa
    usuarios[currentUser].clientes.splice(i,1); 
    saveUsuarios(usuarios); 
    mostrarClientes(); 
    
    // Mostrar notificaci√≥n de eliminaci√≥n
    showNotification(`Cliente "${telCliente}" eliminado de la base de datos`, 'error');
  }
}

function showNotification(message, type = 'success') {
  // Crear elemento de notificaci√≥n
  const notification = document.createElement('div');
  notification.className = `notification ${type === 'success' ? 'success' : type === 'warning' ? 'warning' : ''}`;
  notification.textContent = message;
  
  // Agregar al body
  document.body.appendChild(notification);
  
  // Mostrar con animaci√≥n
  setTimeout(() => {
    notification.classList.add('show');
  }, 100);
  
  // Ocultar despu√©s de 3 segundos
  setTimeout(() => {
    notification.classList.remove('show');
    setTimeout(() => {
      if (notification.parentNode) {
        document.body.removeChild(notification);
      }
    }, 300);
  }, 3000);
}

function exportarExcelClientes(){
  let usuarios=loadUsuarios();
  if(!usuarios[currentUser] || !usuarios[currentUser].clientes || usuarios[currentUser].clientes.length === 0){
    alert('No hay clientes para exportar');
    return;
  }
  
  let datos=usuarios[currentUser].clientes.map(c=>({
    Telefono: c.tel,
    Pago: c.pago,
    Motocicleta: c.motocicleta,
    Comentario: c.comentario,
    Fecha: c.fecha
  }));
  
  let wb=XLSX.utils.book_new();
  let ws=XLSX.utils.json_to_sheet(datos);
  XLSX.utils.book_append_sheet(wb,ws,"Clientes");
  XLSX.writeFile(wb, `clientes_${currentUser.replace('@', '_').replace('.', '_')}_${new Date().toLocaleDateString().replace(/\//g, '-')}.xlsx`);
}

function mostrarUsuarios(){
  let usuarios=loadUsuarios();
  let tbody=document.querySelector("#tablaUsuarios tbody");
  tbody.innerHTML="";
  
  Object.keys(usuarios).forEach(email=>{
    const cantidadClientes = usuarios[email].clientes ? usuarios[email].clientes.length : 0;
    const emailTruncado = email.length > 25 ? email.substring(0, 25) + '...' : email;
    const cleanEmail = email.replace(/[^a-zA-Z0-9]/g, '');
    
    tbody.innerHTML += `<tr>
      <td title="${email}">${emailTruncado}</td>
      <td>
        <div style="position: relative; width: 100%;">
          <input type="password" value="${usuarios[email].password}" id="pass_${cleanEmail}" readonly style="width: calc(100% - 25px); font-size: 10px; padding: 2px 20px 2px 4px;">
          <span class="toggle-password" onclick="toggleUserPassword('${cleanEmail}')" style="position: absolute; right: 2px; top: 2px; font-size: 10px; cursor: pointer;">üëÅÔ∏è</span>
        </div>
      </td>
      <td>${cantidadClientes}</td>
      <td>
        <div style="display: flex; gap: 2px; justify-content: center;">
          <button class="edit-btn" onclick="editarUsuario('${email}')" style="font-size: 9px; padding: 2px 4px; width: 45%;">Edit</button>
          <button class="delete-btn" onclick="eliminarUsuario('${email}')" style="font-size: 9px; padding: 2px 4px; width: 45%;">Del</button>
        </div>
      </td>
    </tr>`;
  });
}

function toggleUserPassword(cleanEmail){
  const input = document.getElementById(`pass_${cleanEmail}`);
  const icon = input.nextElementSibling;
  input.type = (input.type === 'password') ? 'text' : 'password';
  icon.textContent = (input.type === 'password') ? 'üëÅÔ∏è' : 'üôà';
}

function editarUsuario(email){
  let usuarios=loadUsuarios();
  let nuevaPass=prompt("Nueva contrase√±a para "+email);
  if(nuevaPass && nuevaPass.trim()){
    usuarios[email].password=nuevaPass.trim();
    saveUsuarios(usuarios);
    mostrarUsuarios();
    alert('Contrase√±a actualizada correctamente');
  }
}

function eliminarUsuario(email){
  if(confirm("¬øEliminar usuario "+email+"? Esta acci√≥n no se puede deshacer.")){
    let usuarios=loadUsuarios();
    delete usuarios[email];
    saveUsuarios(usuarios);
    mostrarUsuarios();
    alert('Usuario eliminado correctamente');
  }
}

function mostrarClientesEliminados(){
  let clientesEliminados = loadClientesEliminados();
  let tbody = document.querySelector("#tablaClientesEliminados tbody");
  tbody.innerHTML = "";
  
  if(clientesEliminados.length === 0){
    tbody.innerHTML = "<tr><td colspan='7' style='text-align: center; color: #666;'>No hay clientes eliminados</td></tr>";
    return;
  }
  
  // Funci√≥n para truncar texto
  const truncateText = (text, maxLength) => {
    if (!text) return '';
    return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
  };
  
  clientesEliminados.forEach((c, i) => {
    tbody.innerHTML += `<tr>
      <td title="${c.fechaEliminacion}" style="font-size: 9px;">${truncateText(c.fechaEliminacion, 16)}</td>
      <td title="${c.eliminadoPor}">${truncateText(c.eliminadoPor, 20)}</td>
      <td title="${c.tel}">${truncateText(c.tel, 12)}</td>
      <td title="${c.motocicleta}">${truncateText(c.motocicleta, 14)}</td>
      <td title="${c.pago}">${truncateText(c.pago, 10)}</td>
      <td title="${c.comentario}">${truncateText(c.comentario, 20)}</td>
      <td title="${c.fechaOriginal}" style="font-size: 9px;">${truncateText(c.fechaOriginal, 16)}</td>
    </tr>`;
  });
}

function exportarExcelClientesEliminados(){
  let clientesEliminados = loadClientesEliminados();
  
  if(clientesEliminados.length === 0){
    alert('No hay clientes eliminados para exportar');
    return;
  }
  
  let datos = clientesEliminados.map(c => ({
    EliminadoPor: c.eliminadoPor,
    Telefono: c.tel,
    Motocicleta: c.motocicleta,
    Pago: c.pago,
    Comentario: c.comentario,
    Estado: c.estado,
    FechaOriginal: c.fechaOriginal,
    FechaEliminacion: c.fechaEliminacion
  }));
  
  let wb = XLSX.utils.book_new();
  let ws = XLSX.utils.json_to_sheet(datos);
  XLSX.utils.book_append_sheet(wb, ws, "ClientesEliminados");
  XLSX.writeFile(wb, `clientes_eliminados_${new Date().toLocaleDateString().replace(/\//g, '-')}.xlsx`);
}

function exportarExcelUsuarios(){
  let usuarios=loadUsuarios();
  
  if(Object.keys(usuarios).length === 0){
    alert('No hay usuarios para exportar');
    return;
  }
  
  let datosUsuarios = Object.keys(usuarios).map(email => ({
    Email: email,
    Contrase√±a: usuarios[email].password,
    CantidadClientes: usuarios[email].clientes ? usuarios[email].clientes.length : 0,
    FechaRegistro: usuarios[email].fechaRegistro || 'Sin fecha',
    Fecha: new Date().toLocaleString()
  }));
  
  let wb=XLSX.utils.book_new();
  let ws=XLSX.utils.json_to_sheet(datosUsuarios);
  XLSX.utils.book_append_sheet(wb, ws, "Usuarios");
  XLSX.writeFile(wb, `usuarios_${new Date().toLocaleDateString().replace(/\//g, '-')}.xlsx`);
}

function exportarExcelTodosClientes(){
  let usuarios=loadUsuarios();
  let todosLosClientes = [];
  
  Object.keys(usuarios).forEach(email => {
    if(usuarios[email].clientes){
      usuarios[email].clientes.forEach(cliente => {
        todosLosClientes.push({
          Telefono: cliente.tel,
          Pago: cliente.pago,
          Motocicleta: cliente.motocicleta,
          Comentario: cliente.comentario,
          Fecha: cliente.fecha
        });
      });
    }
  });
  
  if(todosLosClientes.length === 0){
    alert('No hay clientes para exportar');
    return;
  }
  
  let wb=XLSX.utils.book_new();
  let ws=XLSX.utils.json_to_sheet(todosLosClientes);
  XLSX.utils.book_append_sheet(wb, ws, "TodosLosClientes");
  XLSX.writeFile(wb, `todos_los_clientes_${new Date().toLocaleDateString().replace(/\//g, '-')}.xlsx`);
}

// Inicializar la aplicaci√≥n
document.addEventListener('DOMContentLoaded', function(){
  // Asegurar que todos los paneles est√©n ocultos al inicio excepto login
  document.getElementById("adminLogin").style.display = "none";
  document.getElementById("dashboard").style.display = "none";
  document.getElementById("adminPanel").style.display = "none";
  document.getElementById("configPanel").style.display = "none";
  document.getElementById("login").style.display = "block";
});
</script>
</body>
</html>